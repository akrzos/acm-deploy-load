---
apiVersion: ran.openshift.io/v1
kind: PolicyGenTemplate
metadata:
  name: "common"
  namespace: "ztp-common"
spec:
  bindingRules:
    # These policies will correspond to all clusters with this label:
    common: "true"
  sourceFiles:
    # Create operators policies that will be installed in all clusters
    - fileName: SriovSubscription.yaml
      policyName: "{{ 'sriov-subs' if manyPolicies else 'subscriptions' }}-policy"
{% if extraHubTemplates %}
      metadata:
        annotations:
          {%- raw %}
          scale-test-label-1: '{{hub fromConfigMap "" "common-template-map" "key1" hub}}'
          scale-test-label-2: '{{hub fromConfigMap "" "common-template-map" "key2" hub}}'
          {%- endraw +%}
{% endif %}
      spec:
        source: {{ common_catalogsource_name }}
    - fileName: SriovSubscriptionNS.yaml
      policyName: "{{ 'sriov-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: SriovSubscriptionOperGroup.yaml
      policyName: "{{ 'sriov-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: SriovOperatorStatus.yaml
      policyName: "{{ 'sriov-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: PtpSubscription.yaml
      policyName: "{{ 'ptp-subs' if manyPolicies else 'subscriptions' }}-policy"
{% if extraHubTemplates %}
      metadata:
        annotations:
          {%- raw %}
          scale-test-label-1: '{{hub fromConfigMap "" "common-template-map" "key3" hub}}'
          scale-test-label-2: '{{hub fromConfigMap "" "common-template-map" "key4" hub}}'
          {%- endraw +%}
{% endif %}
      spec:
        source: {{ common_catalogsource_name }}
    - fileName: PtpSubscriptionNS.yaml
      policyName: "{{ 'ptp-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: PtpSubscriptionOperGroup.yaml
      policyName: "{{ 'ptp-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: PtpOperatorStatus.yaml
      policyName: "{{ 'ptp-subs' if manyPolicies else 'subscriptions' }}-policy"
# Start PAO
{% if disconnected_operator_index_tag in ["v4.11", "v4.12", "v4.13"] %}
    # - fileName: PaoSubscription.yaml
    #   policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
    #   spec:
    #     source: {{ common_catalogsource_name }}
    #   # Changing the channel value will upgrade/downgrade the operator installed version.
    #     channel: "{{ pao_subscription_channel }}"
    # - fileName: PaoSubscriptionNS.yaml
    #   policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
    # - fileName: PaoSubscriptionOperGroup.yaml
    #   policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
    # - fileName: PaoOperatorStatus.yaml
    #   policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
{% else %}
    - fileName: PaoSubscription.yaml
      policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
{% if extraHubTemplates %}
      metadata:
        annotations:
          {%- raw %}
          scale-test-label-1: '{{hub fromConfigMap "" "common-template-map" "key1" hub}}'
          scale-test-label-2: '{{hub fromConfigMap "" "common-template-map" "key2" hub}}'
          {%- endraw +%}
{% endif %}
      spec:
        source: {{ common_catalogsource_name }}
      # Changing the channel value will upgrade/downgrade the operator installed version.
        channel: "{{ pao_subscription_channel }}"
    - fileName: PaoSubscriptionNS.yaml
      policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: PaoSubscriptionOperGroup.yaml
      policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: PaoOperatorStatus.yaml
      policyName: "{{ 'pao-subs' if manyPolicies else 'subscriptions' }}-policy"
{% endif %}
# End PAO
    - fileName: ClusterLogNS.yaml
      policyName: "{{ 'log-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: ClusterLogOperGroup.yaml
      policyName: "{{ 'log-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: ClusterLogSubscription.yaml
      policyName: "{{ 'log-subs' if manyPolicies else 'subscriptions' }}-policy"
{% if extraHubTemplates %}
      metadata:
        annotations:
          {%- raw %}
          scale-test-label-1: '{{hub fromConfigMap "" "common-template-map" "key3" hub}}'
          scale-test-label-2: '{{hub fromConfigMap "" "common-template-map" "key4" hub}}'
          {%- endraw +%}
{% endif %}
      spec:
        source: {{ common_catalogsource_name }}
    - fileName: ClusterLogOperatorStatus.yaml
      policyName: "{{ 'log-subs' if manyPolicies else 'subscriptions' }}-policy"
{% if include_clo_fix %}
    - fileName: logging-openshift-io_elasticsearches.yaml
      policyName: "config-policy"
{% else %}
    #- fileName: logging-openshift-io_elasticsearches.yaml
    #  policyName: "config-policy"
{% endif %}
    - fileName: StorageNS.yaml
      policyName: "{{ 'storage-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: StorageOperGroup.yaml
      policyName: "{{ 'storage-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: StorageSubscription.yaml
      policyName: "{{ 'storage-subs' if manyPolicies else 'subscriptions' }}-policy"
{% if extraHubTemplates %}
      metadata:
        annotations:
          {%- raw %}
          scale-test-label-1: '{{hub fromConfigMap "" "common-template-map" "key1" hub}}'
          scale-test-label-2: '{{hub fromConfigMap "" "common-template-map" "key2" hub}}'
          {%- endraw +%}
{% endif %}
      spec:
        source: {{ common_catalogsource_name }}
    - fileName: StorageOperatorStatus.yaml
      policyName: "{{ 'storage-subs' if manyPolicies else 'subscriptions' }}-policy"
    - fileName: ReduceMonitoringFootprint.yaml
      policyName: "{{ 'monitoring-config' if manyPolicies else 'config' }}-policy"
    #
    # These CRs are in support of installation from a disconnected registry
    #
    - fileName: OperatorHub.yaml
      policyName: "config-policy"
    - fileName: DefaultCatsrc.yaml
      policyName: "config-policy"
      # The Subscriptions all point to redhat-operators. The OperatorHub CR
      # disables the defaults and this CR replaces redhat-operators with a
      # CatalogSource pointing to the disconnected registry. Including both of
      # these in the same policy orders their application to the cluster.
      metadata:
        name: {{ common_catalogsource_name }}
{% if extraHubTemplates %}
        annotations:
          {%- raw %}
          scale-test-label-1: '{{hub fromConfigMap "" "common-template-map" "key3" hub}}'
          scale-test-label-2: '{{hub fromConfigMap "" "common-template-map" "key4" hub}}'
          {%- endraw +%}
{% endif %}
      spec:
        displayName: disconnected-redhat-operators
        image: {{ rhacm_disconnected_registry }}:{{ rhacm_disconnected_registry_port }}/{{ disconnected_operator_index_name }}:{{ disconnected_operator_index_tag }}
      status:
        connectionState:
          lastObservedState: READY
    - fileName: DisconnectedICSP.yaml
      policyName: "config-policy"
      spec:
        repositoryDigestMirrors:
        - mirrors:
          - {{ rhacm_disconnected_registry }}:{{ rhacm_disconnected_registry_port }}
          source: registry.redhat.io
